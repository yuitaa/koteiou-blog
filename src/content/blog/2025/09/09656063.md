---
title: 'マップ画像の読み込み改善'
pubDate: 2025-09-02
tags: ['日記', 'ブログ']
---

[投稿一覧](/timeline)ページで表示しているU2カスタムマップ画像の読み込みが激遅だったので改善した。

改善前は `https://u2.unrailed-online.com/CustomMap/Screenshot/{マップid}` の画像をそのまま表示していたが、これだと読み込みが遅かった。

```js title="pages/api/u2-image/[id].webp.js"
import unrailedMaps from '@/data/unrailedMaps.json';
import sharp from 'sharp';

export async function GET({ params, request }) {
  const response = await fetch(
    `https://u2.unrailed-online.com/CustomMap/Screenshot/${params.id}`,
  );

  const imageBuffer = await response.arrayBuffer();

  // Sharpを使って画像をリサイズし、WebPに変換
  const resizedImageBuffer = await sharp(imageBuffer)
    .resize(640)
    .webp({ quality: 80 })
    .toBuffer();

  return new Response(resizedImageBuffer, {
    headers: { 'Content-Type': 'image/webp' },
  });
}

export function getStaticPaths() {
  return unrailedMaps.map((map) => ({ params: { id: map.customMapId } }));
}
```

そこでビルド時に先に取得した画像を表示するように。代償としてビルドの時間が伸びた。

![](@/assets/2025/09/321f3706-689b-4951-98d0-87d7ceebe4ce.png)

ついでに画像の軽量化を。横幅640pxに縮めたあとwebpに変換している。例えば、`/api/u2-image/49953fcd-2ccc-01d2-0000-000000000000.webp` で次の画像が取得できている。

![](/api/u2-image/49953fcd-2ccc-01d2-0000-000000000000.webp)
